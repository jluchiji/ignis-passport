{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * auth/index.js\n *\n * @author  Denis Luchkin-Zhou <denis@ricepo.com>\n * @license MIT\n */\n\nimport _           from 'lodash';\nimport Parser      from 'body-parser';\nimport Passport    from 'passport';\nimport * as JWT    from 'passport-jwt';\nimport * as Local  from 'passport-local';\n\nimport Strategy       from './strategy';\n\n\n/**\n * passportFactory(2)\n *\n * @description                Authentication middleware factory.\n * @param          {ignis}     Ignis.js namespace.\n * @param          {handler}   Ignis.js request handler with metadata.\n * @returns        {Function}  Express.js middleware instance.\n */\nexport function passportFactory(ignis, handler) {\n  let options  = handler.auth || handler.authenticate || handler.authentication;\n  let strategy = options;\n  if (typeof options === 'object') {\n    strategy = options.strategy;\n    delete options.strategy;\n  } else {\n    options = { };\n  }\n\n  /* Generate nothing if strategy is 'none' or falsy */\n  if (!strategy || /^none$/i.test(strategy)) { return null; }\n\n  /* Resolve aliases first */\n  strategy = ignis.auth.__alias[strategy] || strategy;\n\n  /* Create the corresponding middleware */\n  options = _.merge({ }, ignis.auth.__options, options);\n  return function(req, res, next) {\n    let callback = passportCallback(req, res, next);\n    Passport.authenticate(strategy, options, callback)(req, res, next);\n  };\n}\n\n\n/**\n * passportCallback(3)\n *\n * @description                Creates a custom callback function so that\n *                             authentication errors go through Express.js\n *                             error handler stack instead of having Passport.js\n *                             send out a 401 response.\n * @param          {err}       Error occured during authentication.\n * @param          {user}      User information (if authentication successful).\n * @param          {info}      Additional information.\n */\nexport function passportCallback(req, res, next) {\n  return function(err, user, info) {\n    if (err) { return next(err); }\n\n    if (!user) {\n      let error = new Error('Authentication Failed');\n      error.name = 'IgnisError';\n      error.status = 401;\n      error.details = {\n        sensitive: true,\n        reason: info\n      };\n      return next(error);\n    }\n\n    req.user = user;\n    next();\n  };\n}\n\n\n/**\n * auth(1)\n *\n * @description                Ignis.js extension.\n */\nexport default function auth(Ignis) {\n  Ignis.init(function() {\n    /* Root authentication namespace */\n    this.auth = Object.create(null);\n    this.auth.__alias   = { 'token': 'jwt' };\n    this.auth.__options = { session: false };\n\n    /* Attach passport.js middlewares */\n    this.factories.push(passportFactory);\n    this.root.use(Parser.json());\n    this.root.use(Passport.initialize());\n\n    /* Authentication mechanisms */\n    this.auth.jwt   = Strategy(JWT.Strategy);\n    this.auth.local = Strategy(Local.Strategy);\n  });\n}\n"],"sourceRoot":"/source/"}